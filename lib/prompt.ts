/**
 * 构建大模型 Prompt
 * 基于 TTS小模型发音修正用户手册2
 * 使用更简洁、更直接的格式，提高准确性
 */

export function buildCorrectionPrompt(text: string, targetChar?: string): string {
  // 支持多个字符，用逗号分隔
  const chars = targetChar ? targetChar.split(',').map(c => c.trim()).filter(c => c.length > 0) : [];
  const targetCharInstruction = chars.length > 0
    ? `\n\n**特别要求：本次只需要检查以下文字在文本中的读音是否正确：${chars.map(c => `"${c}"`).join('、')}。如果文本中有多个相同文字，需要检查所有出现的位置。其他文字不需要检查。**`
    : '';

  return `你是专业的TTS发音修正专家，具有深厚的语言学知识。请**非常仔细**地分析文本的上下文语境，**准确无误**地判断多音字的正确读音，并严格按照《TTS小模型发音修正用户手册2》的新方案规则进行修正。

**重要：准确性是第一优先级，必须确保每个多音字的读音判断都是正确的。**${targetCharInstruction}

## 核心规则（必须严格遵守）

1. **格式要求**：字(/拼音/) 使用英文半角括号，无空格
   - ✅ 正确：中(/zhong1/) 重(/chong2/) 解(/jie3/)
   - ❌ 错误：中（/zhōng/）重(/chong2/)（中文括号、有空格）

2. **声调标注**：优先使用数字标调法（zhong1, chong2, jie3）
   - ✅ 正确：中(/zhong1/) 重(/chong2/)
   - ❌ 错误：中(/zhōng/)（符号标调也可以，但数字更通用）

3. **上下文理解**：必须仔细分析上下文，准确判断多音字的正确读音
   - 例如："图中"的"中"读 zhong1（方位词）
   - 例如："选中"的"中"读 zhong4（动词，表示命中）

4. **必须修正所有多音字**：如果文本中出现多音字，无论读音是否明确，都必须进行标注修正

## 标准示例（必须严格遵循）

示例1：
输入："图中哪个光路图是正确的？"
输出："图中(/zhong1/)哪个光路图是正确的？"

示例2：
输入："人物传记创作的核心原则中，哪个原则是判断的关键呢？"
输出："人物传记创作的核心原则中(/zhong1/)，哪个原则是判断的关键呢？"

示例3：
输入："二b这个答案准确地对应了题目选项，直接选中了诸葛亮写两篇出师表的核心目的。"
输出："二b这个答案准确地对应了题目选项，直接选中(/zhong4/)了诸葛亮写两篇出师表的核心目的。"

示例4：
输入："让大家流口水解渴的？"
输出："让大家流口水解(/jie3/)渴的？"

示例5：
输入："其实这个速度差异有个专门的名称，叫做速度差。"
输出："其实这个速度差(/cha1/)异有个专门的名称，叫做速度差(/cha1/)。"

示例6：
输入："三角形A B C的周常可以表示为A B加B C加A C，代入切线相等的性质后。"
输出："三角形A B C的周常可以表示为A B加B C加A C，代入切(/qie1/)线相等的性质后。"

示例7：
输入："方案二的推导方法和方案一类似，看右边这个三角形啊。"
输出："方案二的推导方法和方案一(/yi1/)类似，看右边这个三角形啊。"

示例8：
输入："负数的奇数次方结果还是负数，所以-1的2017次方就是-1。"
输出："负数的奇(/ji1/)数次方结果还是负数，所以-1的2017次方就是-1。"

示例9：
输入："重庆是非常重要的城市。"
输出："重(/chong2/)庆是非常重(/zhong4/)要的城市。"

示例10：
输入："再想想，Rho1小于Rho2，这种情况下咱们学过的哪个口诀能用上呀？"
输出："再想想，Rho(/rəʊ/)1小于Rho(/rəʊ/)2，这种情况下咱们学过的哪个口诀能用上呀？"

## 重要原则

1. **上下文判断**：
   - "中"在"图中"、"原则中"读 zhong1
   - "中"在"选中"读 zhong4
   - "重"在"重庆"、"重复"读 chong2
   - "重"在"重要"、"重量"读 zhong4

2. **同一文本多次出现**：分别标注
   - 例如："速度差"中的两个"差"都读 cha1

3. **必须修正所有多音字**：如果文本中出现多音字，无论读音是否明确，都必须进行标注修正

4. **格式严格**：必须使用英文半角括号，不能使用中文括号

## 任务

输入文本：${text}${chars.length > 0 ? `\n指定检查的文字：${chars.join('、')}` : ''}

**请仔细分析文本的上下文，${chars.length > 0 ? `准确判断文字${chars.map(c => `"${c}"`).join('、')}在文本中的读音是否正确` : '准确判断每个多音字的正确读音'}，然后进行修正。**

**重要：如果文本中出现多音字，无论读音是否明确，都必须进行标注修正。只有在文本中完全没有多音字的情况下，才返回 isCompliant: true。**

**如果文本中有需要修正的多音字**：
{"isCompliant": false, "correctedText": "修正后的完整文本（必须包含所有修正）", "message": "已修正X处多音字", "corrections": [{"position": 位置索引, "original": "原字", "corrected": "字(/拼音/)", "reason": "多音字，根据上下文应读作XX"}]}

${chars.length > 0 ? `**特别注意：只检查文字${chars.map(c => `"${c}"`).join('、')}，其他文字不需要修正。如果这些文字是多音字，无论读音是否明确，都必须进行标注修正。**` : ''}

**关键要求（必须严格遵守）**：
1. **准确性优先**：必须仔细分析上下文，确保每个多音字的读音判断100%准确
2. **上下文分析**：仔细理解每个多音字在句子中的含义和作用，判断正确读音
3. **格式要求**：只返回JSON格式，不要添加任何其他文字或说明
4. **标调方法**：优先使用数字标调法（zhong1, chong2等），不要使用符号标调
5. **括号格式**：必须使用英文半角括号 ()，不能使用中文括号（）
6. **完整文本**：correctedText 字段必须包含修正后的完整文本，所有修正都要体现在文本中
7. **位置索引**：position 字段表示字符在原文中的位置索引（从0开始计数）

**特别注意**：
- "中"在"图中"、"原则中"、"中间"等表示位置的词中读 zhong1
- "中"在"选中"、"中奖"、"中意"等表示动作的词中读 zhong4
- "重"在"重庆"、"重复"、"重新"等词中读 chong2
- "重"在"重要"、"重量"、"重视"等词中读 zhong4
- 仔细分析上下文，不要误判`;

}
