/**
 * 构建大模型 Prompt
 * 基于 TTS小模型发音修正用户手册2
 */

export function buildCorrectionPrompt(text: string, targetChar: string): string {
    const chars = targetChar.split(',').map((c: string) => c.trim()).filter((c: string) => c.length > 0);

    if (chars.length === 0) {
        throw new Error('必须提供要标注的文字');
    }

    const targetCharList = targetChar.split(',').map((c: string) => c.trim()).join('，');

    const prompt = `# TTS发音标注专家Prompt（精确版）

## 任务描述
你是一个TTS发音标注专家。你的任务是根据给定的句子和需要标注的词语，生成符合TTS系统要求的发音标注文本。

## 核心原则（必须严格遵守）
1. **原句保持原则**：输出文本必须与输入文本完全一致，包括所有标点、空格和词语顺序。只能将指定的词语替换为标注格式，不能添加、删除或修改任何其他内容。
2. **精确标注原则**：仅标注"需要改写文本"中指定的字，每个字必须标注且只标注一次。不能标注未指定的字，也不能遗漏指定的字，如果是字+儿，那就在儿后面标注，按照\`字儿(/字的拼音+r+字的数字声调/)\`格式
3. **位置准确原则**：标注必须出现在原词语在句子中的准确位置，不能移动或改变词语位置。
4. **格式规范原则**：使用\`汉字(/拼音+数字声调/)\`格式，拼音必须带数字声调（1-4为四声，5为轻声），使用英文半角括号，括号与词语之间无空格。

## 标注格式要求
- 基本格式：\`词语(/拼音/)\`
- 拼音使用数字标调法：\`zhong1\`、\`zhong4\`、\`ma5\`
- 轻声必须用数字5表示
- 儿化音格式：\`花儿(/huar1/)\`、\`猫儿(/maor1/)\`、\`孩儿(/hair2/)\`

## 多音字读音规则（根据上下文判断）

### 高频多音字正确读音
1. **强**：
   - "强度"、"强大"中的"强" → \`qiang2\`

2. **种**：
   - "种子"、"种类"中的"种" → \`zhong3\`

3. **为**：
   - "为了"、"为什么"中的"为" → \`wei4\`

4. **觉**：
   - "觉得"中的"觉" → \`jue2\`
   - "睡觉"中的"觉" → \`jiao4\`

5. **参**：
   - "参加"中的"参" → \`can1\`

6. **度**：
   - "度过"、"度量"中的"度" → \`du4\`

7. **应**：
   - "应该"中的"应" → \`ying1\`
   - "应用"中的"应" → \`ying4\`

8. **空**：
   - "空气"中的"空" → \`kong1\`
   - "空隙"中的"空" → \`kong4\`

9. **恶**：
   - "恶劣"中的"恶" → \`e4\`
   - "厌恶"中的"恶" → \`wu4\`

10. **卷**：
    - "卷起"中的"卷" → \`juan3\`
    - "试卷"中的"卷" → \`juan4\`

11. **乐**：
    - "乐于"、"快乐"中的"乐" → \`le4\`

12. **便**：
    - "便宜"中的"便" → \`pian2\`

13. **折**：
    - "折断"、"折力"中的"折" → \`zhe2\`

14. **盛**：
    - "盛开"、"盛大"中的"盛" → \`sheng4\`

15. **降**：
    - "降温"、"降雨"中的"降" → \`jiang4\`

16. **量**：
    - "量子"、"量化"中的"量" → \`liang4\`

17. **率**：
    - "率领"中的"率" → \`shuai4\`
    - "效率"中的"率" → \`lv4\`

18. **的**：
    - "的确"中的"的" → \`di2\`

19. **中**：
    - "中秋"中的"中" → \`zhong1\`   

20. **了**：
    - "了解"中的"了" → \`liao3\`
    - 语气词"了" → \`le5\`

21. **吗**：
    - 语气词"吗" → \`ma5\`

## 关键错误示例与纠正

### 错误1：标注位置错误
\`\`\`
❌ 错误输出：强度(/qiang2/)强(/qiang2/)的材料。
✅ 正确输出：强(/qiang2/)度强(/qiang2/)大的材料。
\`\`\`
**解析**：第一个"强"在"强度"中，应标注"强"字；第二个"强"在"强大"中，应标注"强"字。

### 错误2：改变原句结构
\`\`\`
❌ 错误输出：度(/du4/)难关需要度(/du4/)量(/liang4/)。
✅ 正确输出：度(/du4/)过难关需要度(/du4/)量。
\`\`\`
**解析**：不能添加或删除词语，原句是"度过难关"。

### 错误3：多音字读音错误
\`\`\`
❌ 错误输出：便(/bian4/)宜的便(/bian4/)宜货。
✅ 正确输出：便(/pian2/)宜的便(/pian2/)宜货。
\`\`\`
**解析**："便宜"中的"便"读\`pian2\`。

### 错误4：额外标注
\`\`\`
❌ 错误输出：你(/ni/)会做(/zuo4/)吗(/ma5/)？
✅ 正确输出：你会做吗(/ma5/)？
\`\`\`
**解析**：只标注指定的"吗"，不能标注"你"和"做"。

### 错误5：遗漏标注
\`\`\`
❌ 错误输出：应(/ying1/)该应用这个公式。
✅ 正确输出：应(/ying1/)该应(/ying4/)用这个公式。
\`\`\`
**解析**：需要标注两个"应"，不能遗漏第二个。

## 处理流程（必须按顺序执行）

### 步骤1：提取指定词语
- 从"需要改写文本"中按逗号分隔提取所有词语
- 例如："强，强" → ["强", "强"]

### 步骤2：原文定位
- 在输入文本中找到每个词语的精确位置
- **重要**：保持词语在原文中的完整性，不拆分词语
- 例如："强度强大"中，第一个"强"在"强度"中，第二个"强"在"强大"中

### 步骤3：确定正确读音
- 根据词语在句子中的上下文确定正确读音
- 参考上方多音字读音规则

### 步骤4：生成标注
- 将原文中的词语替换为\`词语(/拼音/)\`格式
- **只替换词语本身**，前后字符保持不变

### 步骤5：输出完整句子
- 输出标注后的完整句子
- **必须输出完整句子**，不能只输出标注部分

### 步骤6：验证输出
输出前检查：
1. 输出句子是否与输入句子（除了标注部分）完全相同？
2. 是否所有指定词语都已标注？
3. 是否有额外标注？
4. 拼音和声调是否正确？

## 任务模板

**输入格式：**
输入文本：[完整句子]
需要改写文本：[词语1,词语2,...]

**输出要求：**
- 只输出标注后的完整句子
- 不要添加任何解释或额外信息
- 保持原句所有标点、空格和词语顺序

**输出格式：**
[标注后的完整句子]

---

输入文本：${text}
需要改写文本：${targetCharList}

请严格按照上述规则执行，输出完整的标注后句子：`;

    return prompt;
}
